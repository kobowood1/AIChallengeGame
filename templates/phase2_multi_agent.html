{% extends "base.html" %}

{% block title %}Republic of Bean - Multi-Agent Policy Discussion{% endblock %}

{% block head %}
<style>
    body {
        background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
        min-height: 100vh;
        color: #374151;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .main-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1.5rem;
    }
    
    .page-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        text-align: center;
    }
    
    .conversation-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        min-height: 600px;
        display: flex;
        flex-direction: column;
    }
    
    .message-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: #fafafa;
        border-radius: 12px;
        margin-bottom: 1rem;
        max-height: 500px;
    }
    
    .message {
        margin-bottom: 1.5rem;
        padding: 1rem 1.25rem;
        border-radius: 12px;
        position: relative;
        max-width: 85%;
        word-wrap: break-word;
        line-height: 1.6;
    }
    
    .moderator-message {
        background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
        border: 2px solid #f59e0b;
        color: #92400e;
        max-width: 100%;
        margin: 0 auto;
        text-align: center;
    }
    
    .agent-message {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        border: 2px solid #22c55e;
        color: #166534;
        margin-right: auto;
    }
    
    .user-message {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border: 2px solid #3b82f6;
        color: #1e40af;
        margin-left: auto;
    }
    
    .message-header {
        font-weight: 700;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .message-icon {
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        color: white;
    }
    
    .moderator-icon {
        background: #f59e0b;
    }
    
    .agent-icon {
        background: #22c55e;
    }
    
    .user-icon {
        background: #3b82f6;
    }
    
    .user-input-section {
        border-top: 2px solid #f3f4f6;
        padding-top: 1rem;
        display: none;
    }
    
    .user-input-section.active {
        display: block;
    }
    
    .input-group {
        display: flex;
        gap: 1rem;
        align-items: end;
    }
    
    .input-field {
        flex: 1;
        padding: 0.875rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        background: white;
        font-size: 0.875rem;
        min-height: 80px;
        resize: vertical;
        transition: all 0.3s ease;
    }
    
    .input-field:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .submit-btn {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 0.875rem 1.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    
    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
    }
    
    .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .progress-indicator {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #e5e7eb;
        text-align: center;
    }
    
    .progress-bar {
        background: #f3f4f6;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        margin: 0.5rem 0;
    }
    
    .progress-fill {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        height: 100%;
        transition: width 0.3s ease;
    }
    
    .waiting-prompt {
        background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
        border: 2px solid #f59e0b;
        border-radius: 12px;
        padding: 1rem;
        margin: 1rem 0;
        text-align: center;
        font-style: italic;
        color: #92400e;
    }
    
    .final-decision-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        display: none;
    }
    
    .final-decision-section.active {
        display: block;
    }
    
    .policy-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }
    
    .policy-option {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .policy-option:hover {
        border-color: #3b82f6;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .policy-option.selected {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    }
    
    .option-title {
        font-weight: 700;
        color: #374151;
        margin-bottom: 0.5rem;
    }
    
    .option-cost {
        background: #f3f4f6;
        color: #6b7280;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.75rem;
        display: inline-block;
        margin-bottom: 0.5rem;
    }
    
    .option-description {
        color: #6b7280;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-track {
        background: #f3f4f6;
        border-radius: 3px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #f59e0b;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">Multi-Agent Policy Discussion</h1>
        <p class="text-lg text-gray-600 leading-relaxed">
            You will now engage in a structured discussion with four AI representatives about refugee education policy.
            Each agent will share their perspective and ask you a question. After hearing from all agents, you'll make a final group recommendation.
        </p>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-indicator">
        <div class="text-sm font-medium text-gray-700 mb-1">Discussion Progress</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
        <div class="text-xs text-gray-500" id="progress-text">Waiting to begin...</div>
    </div>

    <!-- Conversation Panel -->
    <div class="conversation-panel">
        <div class="message-container scrollbar-thin" id="message-container">
            <!-- Moderator Introduction -->
            <div class="message moderator-message">
                <div class="message-header">
                    <div class="message-icon moderator-icon">
                        <i class="fas fa-gavel"></i>
                    </div>
                    Moderator
                </div>
                <div>{{ moderator_intro }}</div>
            </div>
        </div>
        
        <!-- User Input Section -->
        <div class="user-input-section" id="user-input-section" style="display: none;">
            <div class="waiting-prompt" id="waiting-prompt">
                Please answer the question above to continue the discussion...
            </div>
            <div class="input-group">
                <textarea 
                    id="user-response" 
                    class="input-field" 
                    placeholder="Share your thoughts and respond to the agent's question..."
                    rows="3"
                ></textarea>
                <button 
                    id="submit-response" 
                    class="submit-btn"
                    onclick="submitUserResponse()"
                >
                    <i class="fas fa-paper-plane mr-2"></i>
                    Submit Response
                </button>
            </div>
        </div>
    </div>

    <!-- Final Decision Section -->
    <div class="final-decision-section" id="final-decision-section">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Final Group Recommendation</h2>
        
        <div class="policy-options">
            {% for option_id, option in policy_options.items() %}
            <div class="policy-option" onclick="selectOption('{{ option_id }}')" data-option="{{ option_id }}">
                <div class="option-title">{{ option.name }}</div>
                <div class="option-cost">Cost: {{ option.cost }} units</div>
                <div class="option-description">{{ option.description }}</div>
            </div>
            {% endfor %}
        </div>
        
        <div class="input-group mt-4">
            <textarea 
                id="final-reasoning" 
                class="input-field" 
                placeholder="Explain your final choice and how the discussion influenced your decision..."
                rows="4"
            ></textarea>
            <button 
                id="submit-final-decision" 
                class="submit-btn"
                onclick="submitFinalDecision()"
                disabled
            >
                <i class="fas fa-check mr-2"></i>
                Submit Decision
            </button>
        </div>
    </div>
</div>

<script>
let currentAgentIndex = 0;
const agentsOrder = ['Amir', 'Salma', 'Lila', 'Leila'];
let waitingForUser = false;
let selectedOption = null;

// Initialize the discussion
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, starting discussion...');
    // Start with first agent after a brief delay
    setTimeout(() => {
        console.log('Starting first agent turn...');
        nextAgentTurn();
    }, 3000);
});

function nextAgentTurn(userResponse = '') {
    if (currentAgentIndex >= agentsOrder.length) {
        // All agents have spoken, show final decision
        showFinalDecision();
        return;
    }
    
    // Hide user input while agent is "thinking"
    document.getElementById('user-input-section').classList.remove('active');
    
    // Update progress
    updateProgress();
    
    // Make API call to get next agent response
    fetch('/api/multi_agent/next_turn', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            user_response: userResponse
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Agent response received:', data);
        if (data.error) {
            console.error('Error:', data.error);
            // Show error message to user
            addModeratorMessage('Sorry, there was an error getting the agent response. Please try again.');
            return;
        }
        
        if (data.type === 'agent_response') {
            // Add agent message to conversation
            addAgentMessage(data.agent_name, data.message);
            
            // Show user input section
            waitingForUser = true;
            console.log('Showing user input section...');
            const inputSection = document.getElementById('user-input-section');
            const userResponse = document.getElementById('user-response');
            
            if (inputSection) {
                inputSection.classList.add('active');
                inputSection.style.display = 'block';
            }
            if (userResponse) {
                userResponse.focus();
            }
            
        } else if (data.type === 'moderator_summary') {
            // Add final moderator summary
            addModeratorMessage(data.message);
            
            // Show final decision section
            setTimeout(() => {
                showFinalDecision();
            }, 1000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function submitUserResponse() {
    const responseText = document.getElementById('user-response').value.trim();
    if (!responseText) {
        alert('Please enter your response before continuing.');
        return;
    }
    
    // Add user message to conversation
    addUserMessage(responseText);
    
    // Clear input
    document.getElementById('user-response').value = '';
    
    // Move to next agent
    currentAgentIndex++;
    waitingForUser = false;
    
    // Continue with next agent
    setTimeout(() => {
        nextAgentTurn(responseText);
    }, 500);
}

function addModeratorMessage(message) {
    const messageContainer = document.getElementById('message-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message moderator-message';
    messageDiv.innerHTML = `
        <div class="message-header">
            <div class="message-icon moderator-icon">
                <i class="fas fa-gavel"></i>
            </div>
            Moderator
        </div>
        <div>${message}</div>
    `;
    messageContainer.appendChild(messageDiv);
    messageContainer.scrollTop = messageContainer.scrollHeight;
}

function addAgentMessage(agentName, message) {
    const messageContainer = document.getElementById('message-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message agent-message';
    messageDiv.innerHTML = `
        <div class="message-header">
            <div class="message-icon agent-icon">
                <i class="fas fa-user"></i>
            </div>
            ${agentName}
        </div>
        <div>${message}</div>
    `;
    messageContainer.appendChild(messageDiv);
    messageContainer.scrollTop = messageContainer.scrollHeight;
}

function addUserMessage(message) {
    const messageContainer = document.getElementById('message-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message user-message';
    messageDiv.innerHTML = `
        <div class="message-header">
            <div class="message-icon user-icon">
                <i class="fas fa-user"></i>
            </div>
            You
        </div>
        <div>${message}</div>
    `;
    messageContainer.appendChild(messageDiv);
    messageContainer.scrollTop = messageContainer.scrollHeight;
}

function updateProgress() {
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    const progress = (currentAgentIndex / agentsOrder.length) * 100;
    progressFill.style.width = progress + '%';
    
    if (currentAgentIndex < agentsOrder.length) {
        progressText.textContent = `Speaking with ${agentsOrder[currentAgentIndex]} (${currentAgentIndex + 1}/${agentsOrder.length})`;
    } else {
        progressText.textContent = 'Discussion complete - Make your final decision';
        progressFill.style.width = '100%';
    }
}

function showFinalDecision() {
    const inputSection = document.getElementById('user-input-section');
    const finalSection = document.getElementById('final-decision-section');
    
    if (inputSection) {
        inputSection.classList.remove('active');
        inputSection.style.display = 'none';
    }
    if (finalSection) {
        finalSection.classList.add('active');
        finalSection.style.display = 'block';
        
        // Scroll to final decision section
        finalSection.scrollIntoView({ 
            behavior: 'smooth' 
        });
    }
}

function selectOption(optionId) {
    // Remove previous selection
    document.querySelectorAll('.policy-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Add selection to clicked option
    document.querySelector(`[data-option="${optionId}"]`).classList.add('selected');
    selectedOption = optionId;
    
    // Enable submit button
    document.getElementById('submit-final-decision').disabled = false;
}

function submitFinalDecision() {
    if (!selectedOption) {
        alert('Please select a policy option before submitting.');
        return;
    }
    
    const reasoning = document.getElementById('final-reasoning').value.trim();
    if (!reasoning) {
        alert('Please explain your reasoning before submitting.');
        return;
    }
    
    // Submit final decision
    fetch('/api/multi_agent/final_decision', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            final_choice: selectedOption,
            reasoning: reasoning
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to phase 3
            window.location.href = data.redirect_url;
        } else {
            console.error('Error submitting decision:', data);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Allow Enter key to submit responses
document.getElementById('user-response').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        submitUserResponse();
    }
});
</script>
{% endblock %}