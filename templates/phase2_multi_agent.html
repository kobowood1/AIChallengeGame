{% extends "base.html" %}

{% block title %}Republic of Bean - Multi-Agent Policy Discussion{% endblock %}

{% block head %}
<style>
    body {
        background: #f8f9fa;
        min-height: 100vh;
        color: #374151;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0;
        padding: 0;
    }

    .header {
        background: #28a745;
        color: white;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .phase-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.9rem;
    }

    .budget-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-weight: 500;
    }

    .user-cards-section {
        background: white;
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #e5e7eb;
        min-height: 120px;
    }

    .user-cards-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #28a745;
        margin-bottom: 1rem;
    }

    .user-cards-scroll {
        display: flex;
        gap: 1rem;
        overflow-x: auto;
        padding-bottom: 0.5rem;
    }

    .user-policy-card {
        background: white;
        border: 2px solid #fbbf24;
        border-radius: 12px;
        padding: 1rem;
        min-width: 280px;
        max-width: 320px;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 0.5rem;
    }

    .user-policy-card .policy-name {
        font-weight: 600;
        color: #f59e0b;
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }

    .user-policy-card .policy-option {
        background: #fef3c7;
        color: #92400e;
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        display: inline-block;
    }

    .user-policy-card .policy-description {
        color: #6b7280;
        font-size: 0.8rem;
        line-height: 1.3;
    }

    .main-discussion {
        display: grid;
        grid-template-columns: 250px 1fr;
        height: calc(100vh - 280px);
        min-height: 500px;
    }

    .participants-sidebar {
        background: #f8f9fa;
        border-right: 1px solid #e5e7eb;
        padding: 1.5rem;
        overflow-y: auto;
    }

    .participants-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 1rem;
    }

    .participant-item {
        background: white;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        border: 1px solid #e5e7eb;
        font-size: 0.9rem;
        font-weight: 500;
        color: #4b5563;
    }

    .participant-item.active {
        background: #dcfce7;
        border-color: #16a34a;
        color: #166534;
    }

    .participant-item.moderator {
        background: #fef3c7;
        border-color: #f59e0b;
        color: #92400e;
    }

    .participant-item.you {
        background: #dbeafe;
        border-color: #3b82f6;
        color: #1e40af;
    }

    .chat-area {
        display: flex;
        flex-direction: column;
        background: white;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: #f8f9fa;
    }

    .message {
        margin-bottom: 1rem;
        max-width: 80%;
        word-wrap: break-word;
    }

    .message.moderator {
        background: #fef3c7;
        color: #92400e;
        border-radius: 12px;
        padding: 1rem;
        margin-left: 0;
    }

    .message.agent {
        background: #dcfce7;
        color: #166534;
        border-radius: 12px;
        padding: 1rem;
        margin-left: 0;
    }

    .message.user {
        background: #dbeafe;
        color: #1e40af;
        border-radius: 12px;
        padding: 1rem;
        margin-left: auto;
        margin-right: 0;
    }

    .message-header {
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .message-content {
        line-height: 1.4;
        font-size: 0.95rem;
    }

    .input-area {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        padding: 1rem 1.5rem;
        background: white;
        border-top: 1px solid #e5e7eb;
    }

    .mic-button {
        background: #6b7280;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .mic-button:hover {
        background: #4b5563;
    }

    .input-area input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 20px;
        background: #f9fafb;
        color: #374151;
        font-size: 0.95rem;
    }

    .input-area input:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
    }

    .send-button {
        padding: 0.75rem 1.5rem;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 20px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
    }

    .send-button:hover {
        background: #2563eb;
    }

    .typing-indicator {
        background: #f3f4f6;
        color: #6b7280;
        padding: 0.5rem 1rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        font-style: italic;
        display: none;
        max-width: 80%;
    }

    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f4f6;
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 1s ease-in-out infinite;
        margin-right: 0.5rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .main-discussion {
            grid-template-columns: 1fr;
        }
        
        .participants-sidebar {
            display: none;
        }
        
        .user-cards-scroll {
            flex-direction: column;
            align-items: center;
        }
        
        .user-policy-card {
            min-width: 100%;
            max-width: 300px;
        }
    }

    .final-recommendations {
        background: white;
        border-top: 1px solid #e5e7eb;
        padding: 2rem;
        display: none;
    }

    .recommendation-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }

    .action-button {
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95rem;
    }

    .accept-button {
        background: #16a34a;
        color: white;
    }

    .accept-button:hover {
        background: #15803d;
    }

    .modify-button {
        background: #f59e0b;
        color: white;
    }

    .modify-button:hover {
        background: #d97706;
    }

    .policy-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .policy-card {
        background: white;
        border: 2px solid #f59e0b;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);
        transition: all 0.3s ease;
    }

    .policy-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
    }

    .policy-title {
        font-weight: 600;
        color: #f59e0b;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .policy-option {
        background: #fef3c7;
        color: #92400e;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        margin-bottom: 0.5rem;
        display: inline-block;
    }

    .policy-description {
        color: #6b7280;
        font-size: 0.9rem;
        line-height: 1.4;
    }
</style>
{% endblock %}

{% block content %}
<div class="header">
    <h1>Republic of Bean: Refugee Education Policy Simulation</h1>
    <div class="phase-info">
        <span>Phase 2/3</span>
        <span class="budget-badge">Multi-Agent Discussion</span>
    </div>
</div>

<div class="user-cards-section">
    <div class="user-cards-title">Phase 2: Group Discussion</div>
    <div class="user-cards-scroll" id="user-cards-scroll">
        <!-- User's policy cards will be populated here -->
    </div>
</div>

<div class="main-discussion">
    <div class="participants-sidebar">
        <div class="participants-title">Participants</div>
        
        <div class="participant-item moderator">Moderator</div>
        <div class="participant-item">Amir</div>
        <div class="participant-item">Salma</div>
        <div class="participant-item">Lila</div>
        <div class="participant-item">Leila</div>
        <div class="participant-item you">You</div>
    </div>

    <div class="chat-area">
        <div class="messages-container" id="messages">
            <div class="message moderator">
                <div class="message-header">Moderator</div>
                <div class="message-content">Welcome to the group discussion phase. You will now discuss your policy choices with four stakeholders from the Republic of Bean. Each stakeholder has their own background and perspective. Let's begin with introductions.</div>
            </div>
        </div>
        
        <div class="typing-indicator" id="typing-indicator">
            <span class="loading-spinner"></span>
            <span id="typing-text">Agent is typing...</span>
        </div>
        
        <div class="input-area">
            <button class="mic-button" title="Voice input">🎤</button>
            <input type="text" id="user-input" placeholder="Type your message...">
            <button class="send-button" id="send-button">Send</button>
        </div>
    </div>
</div>

<!-- Final Recommendations (shown after discussion) -->
<div class="final-recommendations" id="final-recommendations">
    <h2 style="text-align: center; margin-bottom: 2rem; color: #374151;">Final Group Recommendations</h2>
    <div class="policy-cards-grid" id="final-cards-grid">
        <!-- Policy cards will be populated here -->
    </div>
    <div class="recommendation-actions">
        <button class="action-button accept-button" onclick="acceptRecommendation()">
            Accept Group Recommendation
        </button>
        <button class="action-button modify-button" onclick="requestModification()">
            Request Modification
        </button>
    </div>
</div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
// Socket.IO connection
const socket = io();

// DOM elements
const messagesContainer = document.getElementById('messages');
const userInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-button');
const typingIndicator = document.getElementById('typing-indicator');
const finalRecommendations = document.getElementById('final-recommendations');
const userCardsScroll = document.getElementById('user-cards-scroll');

// Discussion state
let currentTurn = 0;
let discussionActive = false;
let agents = [];
let userCanRespond = false;

// Initialize the discussion
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, starting discussion...');
    displayUserPolicyCards();
    startDiscussion();
});

function displayUserPolicyCards() {
    // Get user's policy selections and display them
    const userPolicies = {{ user_selections | tojson | safe }};
    const policyData = {{ policy_data | tojson | safe }};
    
    console.log('User policies:', userPolicies);
    console.log('Policy data:', policyData);
    
    userCardsScroll.innerHTML = '';
    
    if (!userPolicies || Object.keys(userPolicies).length === 0) {
        userCardsScroll.innerHTML = '<div style="padding: 1rem; color: #6b7280;">No policy selections found. Please complete Phase 1 first.</div>';
        return;
    }
    
    Object.keys(userPolicies).forEach(policyName => {
        const optionLevel = userPolicies[policyName];
        const policyInfo = policyData.find(p => p.name === policyName);
        
        console.log(`Processing ${policyName}, level ${optionLevel}, found policy:`, policyInfo);
        
        if (policyInfo && policyInfo.options && policyInfo.options[optionLevel - 1]) {
            const option = policyInfo.options[optionLevel - 1];
            const card = document.createElement('div');
            card.className = 'user-policy-card';
            card.innerHTML = `
                <div class="policy-name">${policyName}</div>
                <div class="policy-option">Option ${optionLevel}</div>
                <div class="policy-description">${option.description || 'Policy option selected'}</div>
            `;
            userCardsScroll.appendChild(card);
        } else {
            // Fallback card for debugging
            const card = document.createElement('div');
            card.className = 'user-policy-card';
            card.innerHTML = `
                <div class="policy-name">${policyName}</div>
                <div class="policy-option">Option ${optionLevel}</div>
                <div class="policy-description">Policy option selected</div>
            `;
            userCardsScroll.appendChild(card);
        }
    });
}

function startDiscussion() {
    console.log('Starting first agent turn...');
    // Start with first agent
    nextTurn();
}

function nextTurn() {
    if (currentTurn >= 7) { // After all agents have spoken
        showFinalRecommendations();
        return;
    }
    
    // Show typing indicator
    showTypingIndicator();
    
    // Make API call to get next agent response
    fetch('/api/multi_agent/next_turn', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            turn: currentTurn
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Agent response received:', data);
        hideTypingIndicator();
        
        if (data.type === 'moderator_summary') {
            addMessage('Moderator', data.message, 'moderator');
            showFinalRecommendations();
        } else if (data.message) {
            addMessage(data.agent_name || 'Agent', data.message, 'agent');
            currentTurn++;
            
            // Schedule next turn
            setTimeout(() => {
                nextTurn();
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        hideTypingIndicator();
    });
}

function addMessage(sender, message, type = 'agent') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.innerHTML = `
        <div class="message-header">${sender}</div>
        <div class="message-content">${message}</div>
    `;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
    typingIndicator.style.display = 'block';
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
    typingIndicator.style.display = 'none';
}

function showFinalRecommendations() {
    // Display final recommendations
    displayFinalPolicyCards();
    finalRecommendations.style.display = 'block';
}

function displayFinalPolicyCards() {
    const finalCardsGrid = document.getElementById('final-cards-grid');
    const userPolicies = {{ user_selections | tojson | safe }};
    const policyData = {{ policy_data | tojson | safe }};
    
    finalCardsGrid.innerHTML = '';
    
    if (!userPolicies || Object.keys(userPolicies).length === 0) {
        finalCardsGrid.innerHTML = '<div style="padding: 1rem; color: #6b7280;">No final recommendations available.</div>';
        return;
    }
    
    Object.keys(userPolicies).forEach(policyName => {
        const optionLevel = userPolicies[policyName];
        const policyInfo = policyData.find(p => p.name === policyName);
        
        if (policyInfo) {
            const option = policyInfo.options[optionLevel - 1];
            const card = document.createElement('div');
            card.className = 'policy-card';
            card.innerHTML = `
                <div class="policy-title">${policyName}</div>
                <div class="policy-option">${option.label}</div>
                <div class="policy-description">${option.summary}</div>
            `;
            finalCardsGrid.appendChild(card);
        }
    });
    
    console.log('Final policy display updated with group recommendations');
}

function acceptRecommendation() {
    // Store the final package in session and proceed to Phase 3
    fetch('/api/multi_agent/accept_recommendation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            accepted: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect_url || '/phase3';
        } else {
            console.error('Error accepting recommendation:', data);
            alert('Error processing your decision. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please try again.');
    });
}

function requestModification() {
    // Handle requesting modification
    alert('Modification request feature coming soon!');
}

// Handle user input
userInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

sendButton.addEventListener('click', sendMessage);

function sendMessage() {
    const message = userInput.value.trim();
    if (message) {
        addMessage('You', message, 'user');
        userInput.value = '';
        
        // Show typing indicator
        showTypingIndicator();
        
        // Simulate agent response after user message
        setTimeout(() => {
            hideTypingIndicator();
            addMessage('Moderator', 'Thank you for your input. The agents will consider your perspective in the final recommendations.', 'moderator');
        }, 2000);
    }
}

// Handle socket events
socket.on('connect', function() {
    console.log('Connected to server');
});

socket.on('disconnect', function() {
    console.log('Disconnected from server');
});

// Enable user input when appropriate
function enableUserInput() {
    userCanRespond = true;
    userInput.disabled = false;
    sendButton.disabled = false;
    userInput.focus();
}

// Enable input by default
enableUserInput();
</script>
{% endblock %}